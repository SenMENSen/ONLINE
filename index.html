<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Онлайн змейка на двоих</title>
  <style>
    canvas { background: #222; display: block; margin: 10px auto; }
  </style>
</head>
<body>
  <h1>Управляй змейкой стрелками, видь другую змейку</h1>
  nvas id="game" width="400" height="t="400"></canvas>
  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const gridSize = 20;
    const ws = new WebSocket(`ws://${location.host}`);
    
    let direction = 'right';
    const snake = [{x: 5, y: 10}, {x:4, y:10}, {x:3, y:10}];
    let snakes = []; // другие змейки
    
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowUp' && direction !== 'down') direction = 'up';
      else if (e.key === 'ArrowDown' && direction !== 'up') direction = 'down';
      else if (e.key === 'ArrowLeft' && direction !== 'right') direction = 'left';
      else if (e.key === 'ArrowRight' && direction !== 'left') direction = 'right';
    });

    ws.onmessage = (msg) => {
      snakes = JSON.parse(msg.data).filter(s => s.id !== ws.id);
      draw();
    };

    function moveSnake() {
      const head = {...snake[0]};
      if (direction === 'up') head.y--;
      else if (direction === 'down') head.y++;
      else if (direction === 'left') head.x--;
      else if (direction === 'right') head.x++;

      // Ограничение на карту (змея из другой стороны)
      if (head.x < 0) head.x = canvas.width / gridSize - 1;
      else if (head.x >= canvas.width / gridSize) head.x = 0;
      if (head.y < 0) head.y = canvas.height / gridSize - 1;
      else if (head.y >= canvas.height / gridSize) head.y = 0;

      snake.unshift(head);
      snake.pop();
    }

    function sendState() {
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({snake}));
      }
    }

    function draw() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      // Своя змейка
      ctx.fillStyle = 'lime';
      for (const s of snake) {
        ctx.fillRect(s.x * gridSize, s.y * gridSize, gridSize, gridSize);
      }
      // Другие змейки
      ctx.fillStyle = 'red';
      for (const sData of snakes) {
        for (const s of sData.snake) {
          ctx.fillRect(s.x * gridSize, s.y * gridSize, gridSize, gridSize);
        }
      }
    }

    function gameLoop() {
      moveSnake();
      sendState();
      draw();
    }

    setInterval(gameLoop, 150);
  </script>
</body>
</html>
